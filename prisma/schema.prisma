generator client {
  provider        = "prisma-client-js"
// previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider          = "postgresql"
  url               = env("PRISMA_DATABASE_URL")
  directUrl         = env("POSTGRES_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
// extensions        = [vector]
}

model Client {
  id                  Int                @id @default(autoincrement())
  name                String
  url                 String?
  cron                String?
  clerkOrganizationId String?            @unique
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @default(now()) @updatedAt
  audits              Audit[]
  auditIssues         AuditIssue[]
  ClientInvite        ClientInvite[]
  memberships         ClientMembership[]
  crawls              Crawl[]
  hreflangLinks       HreflangLink[]
  images              Image[]
  internalLinks       InternalLink[]
  Task                Task[]
  urls                Urls[]
}

model ClientMembership {
  id          Int        @id @default(autoincrement())
  clientId    Int
  clerkUserId String
  role        ClientRole @default(CLIENT_MEMBER)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  client      Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, clerkUserId])
  @@index([clerkUserId])
}

model User {
  id          Int        @id @default(autoincrement())
  clerkUserId String     @unique
  globalRole  GlobalRole @default(NONE)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([clerkUserId])
}

model Crawl {
  id                      Int                      @id @default(autoincrement())
  clientId                Int
  url                     String
  createdAt               DateTime                 @default(now())
  state                   CrawlState               @default(STARTED)
  batchId                 String?
  audit                   Audit?
  contentChangesCurrent   ContentChange[]          @relation("CurrentCrawlChange")
  contentChangesPrevious  ContentChange[]          @relation("PreviousCrawlChange")
  client                  Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  crawlMeta               CrawlMeta?
  embeddingClusters       EmbeddingCluster[]
  hreflangLinks           HreflangLink[]
  images                  Image[]
  internalLinks           InternalLink[]
  internalLinkSuggestions InternalLinkSuggestion[]
  urls                    Urls[]
}

model CrawlMeta {
  id              Int      @id @default(autoincrement())
  crawlId         Int      @unique
  robotsTxtRaw    String?
  robotsTxtRules  Json?
  sitemapUrls     String[]
  createdAt       DateTime @default(now())
  crawl           Crawl    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
}

model Urls {
  id                         Int                      @id @default(autoincrement())
  clientId                   Int
  crawlId                    Int?
  url                        String
  status                     Int?
  redirectTarget             String?
  canonical                  String?
  canonicalStatus            Int?
  isSelfReferencingCanonical Boolean                  @default(false)
  isCanonicalised            Boolean                  @default(false)
  metaTitle                  String?
  metaDescription            String?
  h1                         String[]
  h2                         String[]
  h3                         String[]
  h4                         String[]
  h5                         String[]
  h6                         String[]
  createdAt                  DateTime                 @default(now())
  lastModified               DateTime?
  isPagination               Boolean                  @default(false)
  paginationNext             String?
  paginationPrev             String?
  originalStatus             Int?
  wordCount                  Int?
  metaRobots                 String?
  isNoindex                  Boolean                  @default(false)
  isNofollow                 Boolean                  @default(false)
  hasSchemaMarkup            Boolean                  @default(false)
  schemaTypes                String[]
  responseTimeMs             Int?
  depth                      Int?
  auditIssues                AuditIssue[]
  contentChanges             ContentChange[]
  clusterMembers             EmbeddingClusterMember[]
  hreflangLinks              HreflangLink[]           @relation("HreflangSource")
  hreflangTargets            HreflangLink[]           @relation("HreflangTarget")
  images                     Image[]
  sourceLinks                InternalLink[]           @relation("SourceLinks")
  targetLinks                InternalLink[]           @relation("TargetLinks")
  suggestedSource            InternalLinkSuggestion[] @relation("SourceUrlSuggestions")
  suggestedTarget            InternalLinkSuggestion[] @relation("TargetUrlSuggestions")
  PageEmbedding              PageEmbedding?
  Task                       Task[]
  client                     Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  crawl                      Crawl?                   @relation(fields: [crawlId], references: [id], onDelete: Cascade)

  @@unique([crawlId, url])
}

model Audit {
  id                                   Int          @id @default(autoincrement())
  crawlId                              Int          @unique
  clientId                             Int
  createdAt                            DateTime     @default(now())
  pages_missing_title                  Int          @default(0)
  too_short_title                      Int          @default(0)
  too_long_title                       Int          @default(0)
  pages_missing_description            Int          @default(0)
  too_short_description                Int          @default(0)
  too_long_description                 Int          @default(0)
  pages_missing_h1                     Int          @default(0)
  pages_with_multiple_h1s              Int          @default(0)
  pages_with_duplicate_h1s             Int          @default(0)
  pages_missing_h2                     Int          @default(0)
  pages_with_multiple_h2s              Int          @default(0)
  pages_with_duplicate_h2s             Int          @default(0)
  pages_missing_h3                     Int          @default(0)
  pages_with_multiple_h3s              Int          @default(0)
  pages_with_duplicate_h3s             Int          @default(0)
  pages_missing_h4                     Int          @default(0)
  pages_with_multiple_h4s              Int          @default(0)
  pages_with_duplicate_h4s             Int          @default(0)
  pages_missing_h5                     Int          @default(0)
  pages_with_multiple_h5s              Int          @default(0)
  pages_with_duplicate_h5s             Int          @default(0)
  pages_missing_h6                     Int          @default(0)
  pages_with_multiple_h6s              Int          @default(0)
  pages_with_duplicate_h6s             Int          @default(0)
  pages_200_response                   Int          @default(0)
  pages_3xx_response                   Int          @default(0)
  pages_4xx_response                   Int          @default(0)
  pages_5xx_response                   Int          @default(0)
  score                                Int?
  pages_canonicalised                  Int          @default(0)
  pages_missing_canonical              Int          @default(0)
  canonical_points_to_redirect         Int          @default(0)
  canonical_points_to_404              Int          @default(0)
  canonical_points_to_4xx              Int          @default(0)
  canonical_points_to_5xx              Int          @default(0)
  pages_hreflang_broken_links          Int          @default(0)
  pages_hreflang_missing_return_tag    Int          @default(0)
  pages_hreflang_missing_self_ref      Int          @default(0)
  pages_missing_hreflang_x_default     Int          @default(0)
  pages_orphaned                       Int          @default(0)
  pages_with_broken_internal_links     Int          @default(0)
  pages_with_hreflang                  Int          @default(0)
  pages_with_redirect_links            Int          @default(0)
  total_broken_internal_links          Int          @default(0)
  total_hreflang_broken_links          Int          @default(0)
  total_hreflang_links                 Int          @default(0)
  total_hreflang_missing_return_tags   Int          @default(0)
  total_orphaned_pages                 Int          @default(0)
  total_redirect_internal_links        Int          @default(0)
  pages_301_permanent                  Int          @default(0)
  pages_302_temporary                  Int          @default(0)
  pages_303_see_other                  Int          @default(0)
  pages_307_temporary                  Int          @default(0)
  pages_308_permanent                  Int          @default(0)
  pages_3xx_other                      Int          @default(0)
  pages_401_unauthorized               Int          @default(0)
  pages_403_forbidden                  Int          @default(0)
  pages_404_not_found                  Int          @default(0)
  pages_405_method_not_allowed         Int          @default(0)
  pages_408_timeout                    Int          @default(0)
  pages_410_gone                       Int          @default(0)
  pages_429_rate_limited               Int          @default(0)
  pages_4xx_other                      Int          @default(0)
  pages_500_internal_error             Int          @default(0)
  pages_502_bad_gateway                Int          @default(0)
  pages_503_unavailable                Int          @default(0)
  pages_504_timeout                    Int          @default(0)
  pages_5xx_other                      Int          @default(0)
  pages_with_images_empty_alt          Int          @default(0)
  pages_with_images_missing_alt        Int          @default(0)
  pages_with_images_missing_dimensions Int          @default(0)
  pages_with_unoptimized_image_format  Int          @default(0)
  total_images                         Int          @default(0)
  total_images_empty_alt               Int          @default(0)
  total_images_missing_alt             Int          @default(0)
  total_images_missing_dimensions      Int          @default(0)
  total_images_unoptimized_format      Int          @default(0)
  pages_broken_link_recommendation     Int          @default(0)
  pages_content_similarity             Int          @default(0)
  pages_thin_content                   Int          @default(0)
  pages_noindex                        Int          @default(0)
  pages_nofollow                       Int          @default(0)
  pages_missing_schema                 Int          @default(0)
  pages_with_schema                    Int          @default(0)
  pages_slow_response                  Int          @default(0)
  pages_with_mixed_content             Int          @default(0)
  pages_deep                           Int          @default(0)
  pages_duplicate_title                Int          @default(0)
  pages_duplicate_description          Int          @default(0)
  pages_in_redirect_chain              Int          @default(0)
  pages_broken_pagination              Int          @default(0)
  pages_blocked_by_robots              Int          @default(0)
  pages_in_sitemap_not_crawled         Int          @default(0)
  pages_not_in_sitemap                 Int          @default(0)
  pages_in_sitemap_non_200             Int          @default(0)
  pages_exact_duplicate_content        Int          @default(0)
  pages_non_indexable                  Int          @default(0)
  client                               Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  crawl                                Crawl        @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  issues                               AuditIssue[]
}

model ContentChange {
  id              Int      @id @default(autoincrement())
  currentCrawlId  Int
  previousCrawlId Int
  urlId           Int
  changeType      String
  score           Float?
  createdAt       DateTime @default(now())
  clientId        Int
  currentCrawl    Crawl    @relation("CurrentCrawlChange", fields: [currentCrawlId], references: [id], onDelete: Cascade)
  previousCrawl   Crawl    @relation("PreviousCrawlChange", fields: [previousCrawlId], references: [id], onDelete: Cascade)
  url             Urls     @relation(fields: [urlId], references: [id], onDelete: Cascade)

  @@index([currentCrawlId])
  @@index([urlId])
}

model EmbeddingCluster {
  id        Int                      @id @default(autoincrement())
  crawlId   Int
  label     String?
  density   Float?
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  clientId  Int
  crawl     Crawl                    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  members   EmbeddingClusterMember[]

  @@index([crawlId])
  @@index([clientId, crawlId])
}

model EmbeddingClusterMember {
  id            Int              @id @default(autoincrement())
  clusterId     Int
  urlId         Int
  isHub         Boolean          @default(false)
  distanceToHub Float?
  cluster       EmbeddingCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)
  url           Urls             @relation(fields: [urlId], references: [id], onDelete: Cascade)

  @@unique([clusterId, urlId])
  @@index([urlId])
}

model InternalLinkSuggestion {
  id          Int      @id @default(autoincrement())
  crawlId     Int
  sourceUrlId Int
  targetUrlId Int
  score       Float
  anchorText  String?
  createdAt   DateTime @default(now())
  clientId    Int
  crawl       Crawl    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  sourceUrl   Urls     @relation("SourceUrlSuggestions", fields: [sourceUrlId], references: [id], onDelete: Cascade)
  targetUrl   Urls     @relation("TargetUrlSuggestions", fields: [targetUrlId], references: [id], onDelete: Cascade)

  @@unique([sourceUrlId, targetUrlId])
  @@index([crawlId])
  @@index([sourceUrlId])
}

model AuditIssue {
  id        Int           @id @default(autoincrement())
  clientId  Int
  auditId   Int
  urlId     Int
  issueKey  String
  metadata  Json?
  status    IssueStatus   @default(OPEN)
  priority  IssuePriority @default(MEDIUM)
  fixedAt   DateTime?
  ignoredAt DateTime?
  createdAt DateTime      @default(now())
  audit     Audit         @relation(fields: [auditId], references: [id], onDelete: Cascade)
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  url       Urls          @relation(fields: [urlId], references: [id], onDelete: Cascade)
  Task      Task[]

  @@index([clientId])
  @@index([auditId])
  @@index([issueKey])
  @@index([priority])
  @@index([status])
}

model InternalLink {
  id        Int      @id @default(autoincrement())
  sourceId  Int
  targetId  Int?
  targetUrl String
  clientId  Int
  crawlId   Int
  createdAt DateTime @default(now())
  follow    Boolean  @default(true)
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  crawl     Crawl    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  source    Urls     @relation("SourceLinks", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Urls?    @relation("TargetLinks", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetUrl, crawlId])
  @@index([clientId, crawlId])
  @@index([targetUrl])
  @@index([follow])
  @@index([sourceId])
  @@index([targetId])
}

model HreflangLink {
  id           Int      @id @default(autoincrement())
  clientId     Int
  crawlId      Int
  sourceId     Int
  targetUrl    String
  targetId     Int?
  hreflang     String
  hasReturnTag Boolean  @default(false)
  targetStatus Int?
  createdAt    DateTime @default(now())
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  crawl        Crawl    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  source       Urls     @relation("HreflangSource", fields: [sourceId], references: [id], onDelete: Cascade)
  target       Urls?    @relation("HreflangTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, hreflang, crawlId])
  @@index([clientId, crawlId])
  @@index([targetUrl])
  @@index([crawlId, sourceId])
}

model Image {
  id                Int      @id @default(autoincrement())
  clientId          Int
  crawlId           Int
  urlId             Int
  src               String
  alt               String?
  width             Int?
  height            Int?
  format            String?
  isOptimizedFormat Boolean  @default(false)
  hasDimensions     Boolean  @default(false)
  hasAlt            Boolean  @default(false)
  createdAt         DateTime @default(now())
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  crawl             Crawl    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  url               Urls     @relation(fields: [urlId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([crawlId])
  @@index([urlId])
  @@index([hasAlt])
  @@index([hasDimensions])
  @@index([isOptimizedFormat])
}

model ClientInvite {
  id        Int        @id @default(autoincrement())
  email     String
  token     String     @unique
  clientId  Int
  role      ClientRole @default(CLIENT_MEMBER)
  createdAt DateTime   @default(now())
  expiresAt DateTime
  inviterId String
  Client    Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
}

model Comment {
  id                Int      @id @default(autoincrement())
  taskId            Int
  authorClerkUserId String
  content           String
  createdAt         DateTime @default(now())
  Task              Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model PageEmbedding {
  id            Int                    @id @default(autoincrement())
  urlId         Int                    @unique
  contentVector Unsupported("vector")?
  urlVector     Unsupported("vector")?
  contentHash   String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime
  Urls          Urls                   @relation(fields: [urlId], references: [id], onDelete: Cascade)
}

model Task {
  id                  Int           @id @default(autoincrement())
  clientId            Int
  urlId               Int?
  auditIssueId        Int?
  title               String
  description         String?
  status              IssueStatus   @default(OPEN)
  priority            IssuePriority @default(MEDIUM)
  assigneeClerkUserId String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime
  Comment             Comment[]
  AuditIssue          AuditIssue?   @relation(fields: [auditIssueId], references: [id])
  Client              Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  Urls                Urls?         @relation(fields: [urlId], references: [id])

  @@index([auditIssueId])
  @@index([clientId])
  @@index([urlId])
}

enum GlobalRole {
  NONE
  INTERNAL_ADMIN
}

enum ClientRole {
  INTERNAL_ADMIN
  CLIENT_ADMIN
  CLIENT_MEMBER
  AGENCY_ADMIN
  AGENCY_ANALYST
  CLIENT_VIEWER
}

enum CrawlState {
  STARTED
  ABORTED
  COMPLETED
}

enum IssuePriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  FIXED
  IGNORED
}
